<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Datos del Sheet</title>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body>
  <h1>Cargar pa√≠s del Sheet</h1>

  <select id="pais" name="pais">
    <option value="">Seleccione un pa√≠s</option>
    <option value="argentina">Argentina</option>
    <option value="canada">Canad√°</option>
    <option value="francia">Francia</option>
    <option value="italia">Italia</option>
    <option value="estados_unidos">Estados Unidos</option>
    <option value="alemania">Alemania</option>
    <option value="espana">Espa√±a</option>
    <option value="poznan">poznan</option>
  </select>

  <br><br>

  <button id="btn-cargar-sheet">üì• Cargar datos del Sheet</button>
  <button id="btn-scrapear">üîç Ejecutar scraping Apify</button>

  <div id="resultado" style="margin-top: 20px;"></div>

  <script>
    // üîÅ Cargar datos del Sheet
    $('#btn-cargar-sheet').click(function () {
      const selectedCountry = $('#pais').val();
      debugger;
      if (!selectedCountry) {
        Swal.fire("Error", "Por favor, selecciona un pa√≠s.", "error");
        return;
      }

      Swal.fire({
        title: 'Enviando...',
        text: 'Estamos cargando los datos del pa√≠s: ' + selectedCountry,
        didOpen: () => Swal.showLoading()
      });

      $.ajax({
        url: "/resultado_carga",
        method: "POST",
        data: { sheet_name: selectedCountry },
        success: function (response) {
          Swal.fire("¬°√âxito!", "Los datos se cargaron correctamente.", "success");
        },
        error: function () {
          Swal.fire("Error", "No se pudo cargar el sheet.", "error");
        }
      });
    });

    // üîç Ejecutar scraping Apify
    $('#btn-scrapear').click(function () {
      const selectedCountry = $('#pais').val();

        if (!selectedCountry) {
          Swal.fire("Error", "Por favor, seleccion√° un pa√≠s primero.", "error");
          return;
        }

        Swal.fire({
          title: 'Scrapeando...',
          text: 'Ejecutando b√∫squeda con Apify para: ' + selectedCountry,
          didOpen: () => Swal.showLoading()
        });



        debugger;
      $.ajax({
          url: "/scrape_amazon",
          method: "POST",
          contentType: "application/json",
          data: JSON.stringify({ sheet_name: selectedCountry }),


        success: function (response) {
                if (response.success) {
                          const resultados = response.datos;

                          let contenidoHTML = `
                            <h3>Productos encontrados:</h3>
                            <table border="1" style="width:100%; border-collapse: collapse;">
                              <thead>
                                <tr>
                                  <th>Producto</th>
                                  <th>Imagen</th>
                                  <th>T√≠tulo</th>
                                  <th>Precio</th>
                                  <th>Enlace</th>
                                </tr>
                              </thead>
                              <tbody>`;

                          resultados.forEach(resultado => {
                            // fila de encabezado para el producto
                            contenidoHTML += `
                              <tr style="background:#f0f0f0;">
                                <td colspan="5"><strong>${resultado.producto}</strong> (${resultado.pais})</td>
                              </tr>`;

                            if (resultado.error) {
                              contenidoHTML += `
                                <tr>
                                  <td colspan="5" style="color:red; text-align:center;">
                                    ${resultado.error}
                                  </td>
                                </tr>`;
                            } else {
                              // una fila por cada √≠tem de ese producto
                              resultado.items.forEach(item => {
                                contenidoHTML += `
                                  <tr>
                                    <td><!-- vac√≠o, ya mostramos producto arriba --></td>
                                    <td><img src="${item.imagen}" alt="" width="80"></td>
                                    <td>${item.titulo}</td>
                                    <td>${item.precio} ‚Ç¨</td>
                                    <td><a href="${item.url}" target="_blank">Ver producto</a></td>
                                  </tr>`;
                              });
                            }
                          });

                          contenidoHTML += `
                              </tbody>
                            </table>`;

                          $('#resultado').html(contenidoHTML);
                          Swal.fire("¬°Listo!", "Scraping completado con √©xito.", "success");
                        } else {
                          Swal.fire("Error", response.error || "Algo sali√≥ mal.", "error");
                        }


                        }
                        ,
        error: function () {
          Swal.fire("Error", "No se pudo contactar al backend.", "error");
        }
      });
    });
  </script>
</body>
</html>
